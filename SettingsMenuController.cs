using TMPro;
using UnityEngine;
using UnityEngine.Rendering;
using UnityEngine.UI;

/// <summary>
/// ????????? ???????? ??????? ???????? ? ????????????? ????? ???????????:
/// - Graphics (???????????)
/// - Controls (??????????)
/// - Audio (????)
/// ??????? ?????? ???????? 5 ??????: Graphics, Controls, Audio, ResetDefaults, Close.
/// ResetDefaults ???????? ResetDefaults ? ???? ??????????.
/// Close ????????? ?????? ????? MenuSceneController ??? ???????????? ??????.
/// </summary>
public class SettingsMenuController : MonoBehaviour
{
    [Header("Panels")]
    public GameObject mainPanel;          // ???????? ?????? ? 5 ????????
    public GameObject graphicsPanel;      // ?????????: ???????????
    public GameObject controlsPanel;      // ?????????: ??????????
    public GameObject audioPanel;         // ?????????: ????

    [Header("Main Buttons")]
    public Button btnGraphics;
    public Button btnControls;
    public Button btnAudio;
    public Button btnResetDefaults;
    public Button btnClose;

    [Header("Optional")]
    public MenuSceneController menuController; // ???? ?????? ????? Close ??????????? ???????????? ?????

    [Header("Startup")]
    [Tooltip("Если true — меню откроется автоматически при старте (покажется mainPanel). Если false — все панели будут скрыты и меню останется закрытым.")]
    public bool openOnStart = false;

    void Awake()
    {
        if (btnGraphics != null) btnGraphics.onClick.AddListener(OpenGraphics);
        if (btnControls != null) btnControls.onClick.AddListener(OpenControls);
        if (btnAudio != null) btnAudio.onClick.AddListener(OpenAudio);
        if (btnResetDefaults != null) btnResetDefaults.onClick.AddListener(ResetAllDefaults);
        if (btnClose != null) btnClose.onClick.AddListener(CloseSettings);

        // Start state:
        // - если openOnStart == true — показываем mainPanel (как раньше)
        // - если openOnStart == false — оставляем меню скрытым (все панели деактивируем)
        if (openOnStart)
        {
            ShowOnly(mainPanel);
        }
        else
        {
            // Деактивируем все панели, чтобы меню было скрыто при старте
            if (mainPanel != null) mainPanel.SetActive(false);
            if (graphicsPanel != null) graphicsPanel.SetActive(false);
            if (controlsPanel != null) controlsPanel.SetActive(false);
            if (audioPanel != null) audioPanel.SetActive(false);
        }
    }

    void ShowOnly(GameObject panel)
    {
        if (mainPanel != null) mainPanel.SetActive(panel == mainPanel);
        if (graphicsPanel != null) graphicsPanel.SetActive(panel == graphicsPanel);
        if (controlsPanel != null) controlsPanel.SetActive(panel == controlsPanel);
        if (audioPanel != null) audioPanel.SetActive(panel == audioPanel);
    }

    // Open subpanels
    public void OpenGraphics() => ShowOnly(graphicsPanel);
    public void OpenControls() => ShowOnly(controlsPanel);
    public void OpenAudio() => ShowOnly(audioPanel);

    // Called by Reset Defaults button in main panel
    public void ResetAllDefaults()
    {
        // ????? ????????? ? ??????? ? ??? ResetDefaults, ???? ????? ?????????? ????
        var g = graphicsPanel ? graphicsPanel.GetComponent<GraphicsSettings>() : null;
        var c = controlsPanel ? controlsPanel.GetComponent<ControlsSettings>() : null;
        var a = audioPanel ? audioPanel.GetComponent<AudioSettings>() : null;

        g?.ResetDefaults();
        c?.ResetDefaults();
        a?.ResetDefaults();
    }

    public void CloseSettings()
    {
        // ??????? ????????? ????? MenuSceneController
        if (menuController != null)
        {
            menuController.CloseSettings();
            return;
        }

        // ????? ?????? ???????????? ???????? ?????? (?????????????? ??? ???? ?????? ????? ?? ??????? ??????)
        var root = transform.root;
        if (root != null) root.gameObject.SetActive(false);
        else gameObject.SetActive(false);
    }

    // Optional: ?????????? ??????? Back ? ?????????? (????????? ? ??????????)
    public void BackToMain()
    {
        ShowOnly(mainPanel);
    }
}